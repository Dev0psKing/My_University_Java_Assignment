BEGIN TRANSACTION;

TRY
    UPDATE inventory SET quantity = @new_quantity WHERE product_id = @product_id;
    INSERT INTO inventory_history (product_id, old_quantity, new_quantity, updated_at)
    VALUES (@product_id, @old_quantity, @new_quantity, CURRENT_TIMESTAMP);
    
    COMMIT TRANSACTION;
CATCH
    ROLLBACK TRANSACTION;
    -- Handle error
END TRY;